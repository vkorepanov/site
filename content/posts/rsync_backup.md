+++
date = '2017-12-16T12:00:00+04:00'
draft = false
title = 'Резервное копирование с rsync'
tags = ["linux", "rsync", "backup"]
categories = ["Системное администрирование"]
+++

# Rsync и резервное копирование системы

Мне удобно, когда операционная система содержит следующие разделы:

| Раздел                   | Точка монтирования  | LVM раздел             |
|--------------------------|---------------------|------------------------|
| корневой                 | /                   | rootfs                 |
| загрузочный              | /boot               | \-                     |
| домашний каталог         | /home               | home                   |
| данные и всякий хлам     | /media/data         | mediadata              |
| (фильмы, музыка и т.п.)  |                     |                        |
| диски виртуальных машин  | /media/vms          | vms и vms_slow         |

Делаю резервную копию сделующих разделов:

* /
* /home
* /media/data

Остальные разделы не содержат полезных данных, либо их легко восстановить.

Резервное копирование системы состоит из 3 этапов:

1. [Получение списка разделов](#partitions)
1. [Удаление устаревших и ненужных файлов перед резервным
   копированием](#remove)
1. [Резервное копирование необходимых разделов](#copy)

## Получение списка разделов для резервного копирования {#partitions}

Список примонтированных в данный момент разделов можно узнать командой mount
или lsblk.

Получение списка всех примонтированных разделов:

```bash
lsblk | grep -o '/.*'
```

## Чистка ненужных файлов перед резервным копированием {#remove}

Не нужно ничего чистить, если сильно лень или не важен размер резервной копии.

Используя ncdu можно найти и удалить ненужные файлы больших размеров. Например,
кэш, tmp и т.п.

## Копирование необходимых разделов {#copy}

После того, как становятся известны разделы, резервную копию которых необходимо
сделать, нужно примонтировать устройство, на котором будет храниться резервная
копия.

```bash
mkdir -p /mnt/backup/
mount /dev/sdX /mnt/backup
```

Создаем директорию, в которой сохраним резервную копию и переходим в нее:

```bash
export BACKUP_PATH="$(date --iso-8601)"
mkdir "$BACKUP_PATH"
cd "$BACKUP_PATH"
```

Копируем с помощью rsync разделы по очереди, задавая нужные SRC и DST
переменные:

```bash
rsync --archive --acls --one-file-system --xattrs --verbose "$SRC" "$DST"
```

Сокращенная версия:

```bash
rsync -aAxXv "$SRC" "$DST"
```

Главное не забыть по завершении резервного копирования проверить все ли
работает и валидна ли резервная копия. Вместо rsync можно использовать LVM
снапшоты.

